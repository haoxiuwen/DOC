# 用户在线状态管理

用户在线状态（即 Presence）包含用户的在线、离线以及自定义状态。

// TODO：用户在线状态就是 Presence 吧，Presence 包括在线（包括自定义在线状态）和离线？还有其他吗？

## 在线

用户启动 app 后，客户端和即时通信 IM 服务端成功建立了 TCP 网络连接。客户端可以发消息给即时通信 IM 服务端，也可以收到来自即时通信 IM 服务端推送的消息。即时通信 IM 服务端保存客户端的在线信息，例如客户端的网络链路信息，客户端的平台版本等。App 在运行过程中，**IM SDK 每隔2分钟发一个心跳包给服务器，以确认用户的在线状态。**

// TODO：在线的定义对吗？

## 自定义在线状态

用户可以发布自定义在线状态，例如忙碌、马上回来、离开、接听电话、外出就餐等。

// TODO：自定义状态是用户在线状态的细分吗？

## 离线

离线是指用户成功登出环信即时通讯 IM 系统或与即时通讯 IM 系统断开连接后的状态。用户登出即时通讯 IM 系统之后，无法发送和接收消息，在下次登录后可以接收到离线消息。

// TODO：Web 和小程序端有离线状态吗？只有 Android/iOS/鸿蒙才存在离线状态？还是说除了 Web 和小程序端，其他端都有离线状态？

// TODO：添加离线的场景，例如，腾讯云提到的下面的场景：
a. 用户将App 切后台后进程被手机操作系统 kill 掉，或者用户主动 kill 掉 App 进程。
b. 用户主动关闭客户端网络（例如打开手机飞行模式），或者客户端网络完全不可用（例如进入完全没有网络信号的隧道）。在这种特殊情况下，客户端连 TCP 协议的 FIN 包或 RST 包都无法发出，即时通信 IM 服务端需要等待 5 分钟后发现心跳包超时，状态才会变成离线状态。

// TODO：离线与未登录状态等同吗？还是说离线多长时间内没再登录，就会变成未登录状态。
// TODO：是否有未登录状态，即用户未调用登录接口登录 IM，用户既收不到在线消息，也收不到离线推送通知。

## 用户在线状态变更通知

用户的状态从“在线”变为“离线”时，客户端收到 `OnDisconnected` 通知，从“离线”变为“在线”时，客户端收到 `OnConnected` 通知。

用户发布自定义在线状态后，发布者和订阅者均会收到自定义在线状态变更的回调，例如，Android 为 `EMPresenceListener#onPresenceUpdated` 回调。

当 SDK 监测到当前账号从“自定义在线状态”变更为“离线”状态后，会自动清除自定义状态，并且触发状态变更通知 `OnConnected`。// TODO：这种说法对吗？

// TODO：若用户 A 为离线状态，开发者调用 REST 接口为其设置了在线状态，那么用户 A 为什么状态？


## 状态变更感知的实时性

// TODO：用户状态发生变化时，各端感知的实时性可能不一致。需要按端添加。

## 多端登录

// TODO：描述对吗？

单设备登录场景下，后登录的设备会将之前登录的设备踢下线。被踢下线的设备处于未登录状态，不会收到离线推送。

多设备登录时，若达到登录设备数量的上限，新登录的设备会将之前登录的设备踢下线。被踢下线的设备处于未登录状态，不会收到离线推送。

关于多端登录的，详见[相关文档](multi_device.html)。

## 用户状态回调事件

用户成功登入时，状态为在线，成功登出或被踢下线时，用户状态为离线。

用户登入、登出或被踢时，环信服务器会向你设置的发送后回调地址发送相关事件时携带用户状态，详见[用户登入和登出事件](/document/server-side/callback_configurations.html#用户登入登出)。